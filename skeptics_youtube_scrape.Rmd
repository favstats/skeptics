---
title: "Scrape Comments"
output: html_notebook
---

# Packages

```{r}
#devtools::install_github("soodoku/tuber")

pacman::p_load(tidyverse, tuber, magrittr, stringi, qdapRegex, purrr, lubridate, ggthemes, httr, plyr)

```

# Authentication

```{r}
key <- "AIzaSyDmV5jHx7c8GeAmpTkv6To_ERdkZ_HNl70"

client_id <- "580511698053-p8mu77kktkcvb503g9q737svu9gcq101.apps.googleusercontent.com"

client_key <- "Y0eW96yy-WRg90RZjVJS615o"

tuber::yt_oauth(client_id, client_key)

```

# Read in TXT

```{r}
amazingatheist <- read_file("amazingatheist.txt")
armored <- read_file("armored.txt")
logicked <- read_file("logicked.txt")
thunder <- read_file("thunder.txt")
sargon <- read_file("sargon.txt")

```

# Extract URLs

```{r}

extract_video_ids <- function(video_list) {

video_list %<>% 
  stri_replace_all_fixed(" ", "") %>% 
  stri_replace_all_charclass("\\p{WHITE_SPACE}", "")

url <- rm_between(video_list, "URL:", "Description", extract = TRUE)

imp_vec <- as.vector(url[[1]]) %>% 
  str_replace(pattern = "(.*v\\=)", "")

return(imp_vec)
}

armored_ids <- extract_video_ids(armored)
amazingatheist_ids <- extract_video_ids(amazingatheist)
logicked_ids <- extract_video_ids(logicked)
thunder_ids <- extract_video_ids(thunder)

head(armored_ids)
head(amazingatheist_ids)
head(logicked_ids)
head(thunder_ids)

```

# Armored Skeptic

## Scraping

```{r}
armored_comments <- list()
for (jj in seq_along(armored_ids)) {  
  logicked_comments[[jj]] <- get_all_comments2(logicked_ids[jj])
  cat(jj)
}
```

# Amazing Atheist

## Scraping

- ACHTUNG! REMOVE THE (POSSIBLE) DUPLICATES!
- Test if 45 never works
- Test if 9 never works (in the second sample of 221)

```{r}

# extract function
extract_comments <- function(ids) {
  comments <- list()
for (jj in seq_along(ids)) {  
  try(comments[[jj]] <- get_all_comments2(ids[jj]))
  cat(paste0("\t",jj))
  }
  comments <- suppressWarnings( bind_rows(comments) )
  message(paste("\n\nIteration stopped at:", jj))
  return(comments)
}

# Error : HTTP failure: 401 <- AUTH ERROR

# Error : HTTP failure: 400 <- nonproblematic
# Error : HTTP failure: 403 <- nonproblematic

# Try 1
# missed
c(44, 60, 61, 62, 73, 74, 88) # 7
amazingatheist_comments1 <- extract_comments(amazingatheist_ids)

count(unique(amazingatheist_comments1$videoId))

save(amazingatheist_comments1, file = "data/amazingatheist_comments1.Rdata")

# Try 2
 
amazingatheist_ids1 <- amazingatheist_ids[145:length(amazingatheist_ids)]
amazingatheist_comments2 <-  extract_comments(amazingatheist_ids1)

save(amazingatheist_comments2, file = "data/amazingatheist_comments2.Rdata")

# Try 3

amazingatheist_ids3 <- amazingatheist_ids1[jj:length(amazingatheist_ids1)]
amazingatheist_comments3 <-  extract_comments(amazingatheist_ids3)

save(amazingatheist_comments3, file = "data/amazingatheist_comments3.Rdata")




# old
 
amazingatheist_comments1 <- list()
for (jj in seq_along(amazingatheist_ids)) {  
  amazingatheist_comments1[[jj]] <- get_all_comments2(amazingatheist_ids[jj])
  cat(paste0("\t",jj))
}


save(amazingatheist_comments2, file = "data/amazingatheist_comments2.Rdata")



```

# Logicked

## Scraping

```{r}

logicked_comments <- list()
for (jj in seq_along(logicked_ids)) {  
  logicked_comments[[jj]] <- get_all_comments2(logicked_ids[jj])
  cat(jj)
}

logicked_comments1 <- list()
logicked_ids1 <- logicked_ids[75:length(logicked_ids)]
for (jj in seq_along(logicked_ids1)) {  
  logicked_comments1[[jj]] <- get_all_comments2(logicked_ids1[jj])
  cat(jj)
}

logicked_data1 <- bind_rows(logicked_comments)
logicked_data2 <- bind_rows(logicked_comments1)

logicked_comments <- rbind(logicked_data1, logicked_data2)

#save(logicked_comments, file = "data/logicked_comments.Rdata")


```



# thunderfoot

## Scraping

```{r}
thunder_comments <- list()
for (jj in seq_along(thunder_ids)) {  
  thunder_comments[[jj]] <- get_all_comments2(thunder_ids[jj])
  cat(paste0("\t",jj))
  BRRR::skrrrahh(jj)
}

thunder_comments1 <- bind_rows(thunder_comments)

save(thunder_comments1, file = "data/thunder1.Rdata")

thunder_ids1 <- thunder_ids[183:length(thunder_ids)]
thunder_comments_1 <- list()
for (jj in seq_along(thunder_ids)) {  
  thunder_comments_1[[jj]] <- get_all_comments2(thunder_ids1[jj])
  cat(paste0("\t",jj))
  BRRR::skrrrahh(jj)
}

thunder_comments_2 <- bind_rows(thunder_comments_1)

save(thunder_comments_2, file = "data/thunder2.Rdata")

thunder_ids2 <- thunder_ids1[199:length(thunder_ids1)]
thunder_comments_22 <- list()
for (jj in seq_along(thunder_ids2)) {  
  thunder_comments_22[[jj]] <- get_all_comments2(thunder_ids2[jj])
  cat(paste0("\t",jj))
  BRRR::skrrrahh(jj)
}

thunder_comments_3 <- bind_rows(thunder_comments_22)

save(thunder_comments_3, file = "data/thunder3.Rdata")


thunder_ids3 <- thunder_ids2[178:length(thunder_ids2)]
thunder_comments_222 <- list()
for (jj in seq_along(thunder_ids3)) {  
  thunder_comments_222[[jj]] <- get_all_comments2(thunder_ids3[jj])
  cat(paste0("\t",jj))
  BRRR::skrrrahh(jj)
}

thunder_comments_4 <- bind_rows(thunder_comments_222)

save(thunder_comments_4, file = "data/thunder4.Rdata")

thunder_ids4 <- thunder_ids3[50:length(thunder_ids3)]
thunder_comments_2222 <- list()
for (jj in seq_along(thunder_ids4)) {  
  thunder_comments_2222[[jj]] <- get_all_comments2(thunder_ids4[jj])
  cat(paste0("\t",jj))
  BRRR::skrrrahh(jj)
}

thunder_comments_5 <- bind_rows(thunder_comments_2222)

save(thunder_comments_5, file = "data/thunder5.Rdata")

thunder_ids5 <- thunder_ids4[94:length(thunder_ids4)]
thunder_comments_22222 <- list()
for (jj in seq_along(thunder_ids5)) {  
  thunder_comments_22222[[jj]] <- get_all_comments2(thunder_ids5[jj])
  cat(paste0("\t",jj))
  BRRR::skrrrahh(jj)
}

thunder_comments_6 <- bind_rows(thunder_comments_22222)

save(thunder_comments_6, file = "data/thunder6.Rdata")

thunder_comments <- rbind(thunder_comments1, thunder_comments_2,
                          thunder_comments_3, thunder_comments_4,
                          thunder_comments_5, thunder_comments_6)

save(thunder_comments, file = "data/thunder_comments.Rdata")

```

# get all comments

```{r}
get_all_comments2 <- function(video_id = NULL, ...) 
{
 
  yt_check_token <- function() {

  app_token <- getOption("google_token")
    if (is.null(app_token)) stop("Please get a token using yt_oauth().\n")

  }
  
  tuber_GET <- function(path, query, ...) {

  yt_check_token()

  req <- GET("https://www.googleapis.com", path = paste0("youtube/v3/", path),
                  query = query, config(token = getOption("google_token")), ...)
  
  tuber_check <- function(req) {

  if (req$status_code < 400) return(invisible())

  stop("HTTP failure: ", req$status_code, "\n", call. = FALSE)
  }

  tuber_check(req)
  res <- content(req)

  res
  }
  
  
  
   querylist <- list(videoId = video_id, part = "id,replies,snippet", 
    maxResults = 100)
  res <- tuber_GET("commentThreads", querylist, ...)
  simple_res <- lapply(res$items, function(x) {
    unlist(x$snippet$topLevelComment$snippet)
  })
  simpler_res <- ldply(simple_res, rbind)
  simpler_res$parentId <- NA
  n_replies <- sapply(res$items, function(x) {
    unlist(x$snippet$totalReplyCount)
  })
  if (sum(n_replies) > 1) {
    replies <- lapply(res$items[n_replies > 0], function(x) {
      unlist(x$replies$comments)
    })
    simpler_rep <- ldply(replies, rbind)
    names(simpler_rep) <- gsub("snippet.", "", names(simpler_rep))
    simpler_rep <- subset(simpler_rep, select = -c(kind, 
      etag, id))
    agg_res <- plyr::rbind.fill(simpler_res, simpler_rep)
  }
  agg_res <- simpler_res
  page_token <- res$nextPageToken
  while (is.character(page_token)) {
    querylist$pageToken <- page_token
    a_res <- tuber_GET("commentThreads", querylist, ...)
    simple_res <- lapply(a_res$items, function(x) {
      unlist(x$snippet$topLevelComment$snippet)
    })
    simpler_res <- ldply(simple_res, rbind)
    simpler_res$parentId <- NA
    n_replies <- sapply(a_res$items, function(x) {
      unlist(x$snippet$totalReplyCount)
    })
    if (sum(n_replies) > 1) {
      replies <- lapply(a_res$items[n_replies > 0], function(x) {
        unlist(x$replies$comments)
      })
      simpler_rep <- ldply(replies, rbind)
      names(simpler_rep) <- gsub("snippet.", "", names(simpler_rep))
      simpler_rep <- subset(simpler_rep, select = -c(kind, 
        etag, id))
      agg_res <- plyr::rbind.fill(simpler_res, simpler_rep, agg_res)
      page_token <- a_res$nextPageToken
    }
    agg_res <- plyr::rbind.fill(simpler_res, agg_res)
    page_token <- a_res$nextPageToken
  }
  agg_res
}

```
